/*! 
 * phina-talkbubble 0.1.0
 * MIT Licensed
 * 
 * Copyright (C) pentamania, https://github.com/pentamania
 */

phina.namespace(function(){phina.define("phina.display.TalkBubbleShape",{superClass:"phina.display.Shape",init:function(t){t={}.$safe(t,{width:180,height:150,backgroundColor:"transparent",fill:"white",stroke:"black",strokeWidth:4,tipDirection:"right",tipBasePositionRatio:.5,tipBottomSize:10,cornerRadius:12,tipDeviation:0}),this.superInit(t),this.setBoundingType("rect"),this.cornerRadius=t.cornerRadius,this.tipDirection=t.tipDirection,this.tipBasePositionRatio=t.tipBasePositionRatio,this.tipBottomSize=t.tipBottomSize||.15*Math.min(t.width,t.height),this.tipProtrusion=t.tipProtrusion||this.tipBottomSize,this.tipDeviation=t.tipDeviation,this._fullWidth=t.width,this._fullHeight=t.height,this._resize()},_resize:function(){var t,i,e=this.bubbleWidth=this._cachedWidth!==this.width?this.width:this.bubbleWidth,h=this.bubbleHeight=this._cachedHeight!==this.height?this.height:this.bubbleHeight;"top"===this.tipDirection||"bottom"===this.tipDirection?(i=Math.abs(this.tipDeviation)-e/2,t=Math.max(e,e+2*i),resizedHeight=Math.max(h,h+2*this.tipProtrusion)):(i=Math.abs(this.tipDeviation)-h/2,resizedHeight=Math.max(h,h+2*i),t=Math.max(e,e+2*this.tipProtrusion)),this.setSize(t,resizedHeight),this._cachedWidth=t,this._cachedHeight=resizedHeight;var a=this.canvas,n=this.calcCanvasSize();a.setSize(n.width,n.height),a.clearColor(this.backgroundColor),a.transformCenter(),this._fullWidth=n.width,this._fullHeight=n.height},prerender:function(t){this._resize(),t.talkBubble(-this.bubbleWidth/2,-this.bubbleHeight/2,this.bubbleWidth,this.bubbleHeight,this.cornerRadius,this.tipDirection,this.tipBasePositionRatio,this.tipProtrusion,this.tipDeviation,this.tipBottomSize)},_defined:function(){phina.display.Shape.watchRenderProperties(["cornerRadius","tipDirection","tipBasePositionRatio","tipBottomSize","tipProtrusion","tipDeviation"])},_accessor:{fullWidth:{get:function(){return this._fullWidth}},fullHeight:{get:function(){return this._fullHeight}}}})}),phina.namespace(function(){phina.define("phina.display.ThornedTalkBubbleShape",{superClass:"phina.display.Shape",init:function(t){t={}.$safe(t,{width:320,height:320,backgroundColor:"transparent",fill:"white",stroke:"black",sideThornInterval:15,sideThornSize:30,verticalThornInterval:20,verticalThornSize:10,strokeWidth:4,lineJoin:"miter",miterLimit:100}),this.superInit(t),this.setBoundingType("rect"),this.sideThornInterval=t.sideThornInterval,this.sideThornSize=t.sideThornSize||2*t.sideThornInterval,this.verticalThornInterval=t.verticalThornInterval,this.verticalThornSize=t.verticalThornSize||.5*t.verticalThornInterval,this.lineJoin=t.lineJoin,this.miterLimit=t.miterLimit},render:function(t){var i=t.context,e=this.calcCanvasSize();return t.setSize(e.width,e.height),t.clearColor(this.backgroundColor),t.transformCenter(),this.bubbleWidth=this.width-2*this.sideThornSize,this.bubbleHeight=this.height-2*this.verticalThornSize,t.thornedTalkBubble(-this.width/2,-this.height/2,this.width,this.height,this.verticalThornInterval,this.sideThornInterval,this.verticalThornSize,this.sideThornSize),this.isStrokable()&&(i.strokeStyle=this.stroke,i.lineWidth=this.strokeWidth,i.lineJoin=this.lineJoin,i.miterLimit=this.miterLimit,i.shadowBlur=0,this.renderStroke(t)),this.fill&&(i.fillStyle=this.fill,this.shadow?(i.shadowColor=this.shadow,i.shadowBlur=this.shadowBlur):i.shadowBlur=0,this.renderFill(t)),this},_defined:function(){phina.display.Shape.watchRenderProperties(["verticalThornInterval","verticalThornSize","sideThornSize","sideThornInterval","lineJoin","miterLimit"])}})}),phina.namespace(function(){phina.display.Shape.prototype._getLines=function(){return this.label?(this.label.text+"").split("\n"):[]},phina.display.Shape.prototype._getLabelWidth=function(){var t=this._lines?this._lines:this._getLines(),i=0,e=this.canvas;return e.context.font=this.label.font,t.each(function(t,h){var a=e.context.measureText(t).width;i=Math.max(i,a)}),i},phina.display.Shape.prototype._getLabelHeight=function(){var t=this._lines?this._lines:this._getLines(),i=this.label.fontSize*t.length;return i*=this.label.lineHeight},phina.display.Shape.prototype.adjustToLabelWidth=function(){return this.width=this._getLabelWidth()+2*this.padding,this},phina.display.Shape.prototype.adjustToLabelHeight=function(){return this.height=this._getLabelHeight()+2*this.padding,this},phina.display.Shape.prototype.adjustToLabelSize=function(){return this.adjustToLabelWidth().adjustToLabelHeight(),this}}),phina.namespace(function(){phina.define("phina.ui.TalkBubbleLabel",{superClass:"phina.display.TalkBubbleShape",init:function(t){t={}.$safe(t,{text:"Hello World!",bubbleFill:t.fill||"white",bubbleStroke:t.stroke||"black",textFill:"black",textStroke:"transparent",fontSize:24,textPadding:6,fit:!0});var i={}.$extend(t,{backgroundColor:"transparent",padding:0,fill:t.textFill,stroke:t.textStroke}),e=this.label=phina.ui.LabelArea(i),h={}.$extend(t,{width:e.width,height:e.height,fill:t.bubbleFill,stroke:t.bubbleStroke});this.superInit(h),this.addChild(e),this.text=t.text,this.textPadding=t.textPadding,t.fit&&this.adjustToLabelSize();var a=this._dirtySync=!0;this.on("enterframe",function(){if(a){var t=this.calcCanvasSize();e.setPosition(t.width*(.5-this.originX),t.height*(.5-this.originY)),e.setSize(this.bubbleWidth-2*this.textPadding,this.bubbleHeight-2*this.textPadding),a=!1}});var n=function(t,i){t!==i&&(a=!0)};["bubbleWidth","bubbleHeight","textPadding"].forEach(function(t){this.$watch(t,n)},this),["x","y"].forEach(function(t){this.origin.$watch(t,n.bind(this))},this)},_accessor:{text:{get:function(){return this.label.text},set:function(t){this.label.text=t,this._lines=(this.label.text+"").split("\n")}}}})}),phina.namespace(function(){phina.define("phina.ui.ThornedTalkBubbleLabel",{superClass:"phina.display.ThornedTalkBubbleShape",init:function(t){t={}.$safe(t,{text:"Hello World!",width:230,height:180,bubbleFill:t.fill||"white",bubbleStroke:t.stroke||"black",textFill:"black",textStroke:"transparent",fontSize:24,textPadding:16,fit:!0});var i={}.$extend(t,{fill:t.bubbleFill,stroke:t.bubbleStroke});this.superInit(i);var e={}.$extend(t,{backgroundColor:"transparent",padding:0,fill:t.textFill,stroke:t.textStroke}),h=this.label=phina.ui.LabelArea(e).addChildTo(this);this.textPadding=t.textPadding,t.fit&&this.adjustToLabelSize();var a=!0;this.on("enterframe",function(){if(a){var t=this.calcCanvasSize(),i=2*this.textPadding;h.setPosition(t.width*(.5-this.originX),t.height*(.5-this.originY)),h.setSize(this.bubbleWidth-i,this.bubbleHeight-i),a=!1}});var n=function(t,i){t!==i&&(a=!0)};["bubbleWidth","bubbleHeight","textPadding"].forEach(function(t){this.$watch(t,n)},this),["x","y"].forEach(function(t){this.origin.$watch(t,n.bind(this))},this)},adjustToLabelWidth:function(){return this.width=this._getLabelWidth()+2*this.textPadding+2*this.sideThornSize,this},adjustToLabelHeight:function(){return this.height=this._getLabelHeight()+2*this.textPadding+2*this.verticalThornSize,this},_accessor:{text:{get:function(){return this.label.text},set:function(t){this.label.text=t}}}})}),phina.namespace(function(){phina.graphics.Canvas.prototype.talkBubble=function(t,i,e,h,a,n,s,r,o,l){var d=this.context,u=Math.PI,b=.5*Math.PI,c=t,p=i,g=t+e,f=i+h,T=t+.5*e,v=i+.5*h,S=a,k="right"===(n=n||"right")||"left"===n?p+h*s:c+e*s,x=.5*l;r=r||l;var m,y;switch(n){case"right":m=g+r,y=v+o,d.arc(c+S,p+S,S,-u,-b,!1),d.arc(g-S,p+S,S,-b,0,!1),d.lineTo(g,k-x),d.lineTo(m,y),d.lineTo(g,k+x),d.arc(g-S,f-S,S,0,b,!1),d.arc(c+S,f-S,S,b,u,!1);break;case"left":m=c-r,y=v+o,d.arc(c+S,p+S,S,-u,-b,!1),d.arc(g-S,p+S,S,-b,0,!1),d.arc(g-S,f-S,S,0,b,!1),d.arc(c+S,f-S,S,b,u,!1),d.lineTo(c,k+x),d.lineTo(m,y),d.lineTo(c,k-x);break;case"bottom":m=T+o,y=f+r,d.arc(c+S,p+S,S,-u,-b,!1),d.arc(g-S,p+S,S,-b,0,!1),d.arc(g-S,f-S,S,0,b,!1),d.lineTo(k+x,f),d.lineTo(m,y),d.lineTo(k-x,f),d.arc(c+S,f-S,S,b,u,!1);break;default:m=T+o,y=p-r,d.arc(c+S,p+S,S,-u,-b,!1),d.lineTo(k-x,p),d.lineTo(m,y),d.lineTo(k+x,p),d.arc(g-S,p+S,S,-b,0,!1),d.arc(g-S,f-S,S,0,b,!1),d.arc(c+S,f-S,S,b,u,!1)}return d.closePath(),this},phina.graphics.Canvas.prototype.fillTalkBubble=function(t,i,e,h,a,n,s,r,o,l){return this.beginPath().talkBubble(t,i,e,h,a,n,s,r,o,l).fill()},phina.graphics.Canvas.prototype.strokeTalkBubble=function(t,i,e,h,a,n,s,r,o,l){return this.beginPath().talkBubble(t,i,e,h,a,n,s,r,o,l).stroke()}}),phina.namespace(function(){phina.graphics.Canvas.prototype.thornedTalkBubble=function(t,i,e,h,a,n,s,r){for(var o=this.context,l=a,d=s||.5*a,u=r||2*n,b=[],c=[],p=.6*u,g=1.6*d,f=Math.max(u,p),T=Math.max(d,g),v=(e-2*f)/l|0,S=(h-2*T)/n|0,k=t+f,x=t+e-f,m=i+T,y=i+h-T,z=0;z<S;z++)b.push({x:x,y:m+n*(z+.5)}),c.push({x:k,y:y-n*(z+.5)});o.beginPath(),o.moveTo(k,m);for(z=0;z<v;z++){var w=k+z*l;o.lineTo(w+.25*l,m),o.lineTo(w+.25*l*2,m-d),o.lineTo(w+.25*l*3,m),z!==v-1&&o.lineTo(w+l,m)}o.quadraticCurveTo(x,m,x+p,m-g);z=0;for(var P=b.length;z<P;z++)z%2==0?o.quadraticCurveTo(b[z].x,b[z].y,x+.8*u,m+(z+1)*n):o.quadraticCurveTo(b[z].x,b[z].y,x+u,m+(z+1)*n);for(o.quadraticCurveTo(x,y,x+p,y+g),z=v-1;0<=z;z--){w=k+z*l;o.lineTo(w+.25*l*3,y),o.lineTo(w+.25*l*2,y+d),o.lineTo(w+.25*l,y)}for(o.quadraticCurveTo(k,y,k-p,y+g),z=0,P=c.length;z<P;z++)z%2==0?o.quadraticCurveTo(c[z].x,c[z].y,k-.8*u,y-(z+1)*n):o.quadraticCurveTo(c[z].x,c[z].y,k-u,y-(z+1)*n);return o.quadraticCurveTo(k,m,k-p,m-g),o.closePath(),this},phina.graphics.Canvas.prototype.fillThornedTalkBubble=function(t){return this.beginPath().thornedTalkBubble(x,y,width,height).fill()},phina.graphics.Canvas.prototype.strokeThornedTalkBubble=function(t){return this.beginPath().thornedTalkBubble(x,y,width,height).stroke()}});